<template>
  <div>
    <!-- TODO: refactor into more logical file structure -->
    <LoadingMessage
      v-if="loaded === false"
      :load-failed="loadFailed"
    />
    <div v-if="loaded === true">
      <div class="print-none">
        <h1>User Management</h1>
        <TabsList
          v-model:active-tab="activeTab"
          :tabs="tabs"
        />
      </div>
      <div
        v-show="activeTab == 'users'"
        class="print-full-width"
      >
        <button
          v-if="hasPermissions([PERMISSIONS.users.permissions.canCreateUsers.value])"
          class="govuk-button"
          @click="openCreateUserModal"
        >
          Create
        </button>
        <h2>List of admin users</h2>
        <table class="govuk-table">
          <tr class="govuk-table__row">
            <th
              scope="row"
              class="govuk-table__header"
            >
              User
            </th>
            <th
              scope="row"
              class="govuk-table__header"
            />

            <th
              scope="row"
              class="govuk-table__header"
            >
              Role
            </th>
          </tr>
          <tr
            v-for="(user, userIndex) in users"
            :key="userIndex"
            class="govuk-table__row"
          >
            <td class="govuk-table__cell">
              <div class="govuk-heading-s govuk-!-margin-bottom-1">
                {{ user.displayName }}
              </div>
              <div>
                {{ user.email }}
              </div>
            </td>
            <td class="govuk-table__cell">
              <Warning
                v-if="!user.isJACEmployee"
                :message="'External user'"
              />
            </td>
            <td class="govuk-table__cell">
              <select
                v-model="user.customClaims.r"
                class="govuk-select govuk-!-margin-right-3 govuk-!-margin-bottom-2"
                :disabled="!hasPermissions([PERMISSIONS.users.permissions.canChangeUserRole.value])"
                @change="handleRoleChange(user)"
              >
                <option
                  v-for="(roleItem, roleIndex) in roles"
                  :key="roleIndex"
                  :value="roleItem.id"
                >
                  {{ roleItem.roleName }}
                </option>
              </select>
              <ActionButton
                v-if="user.disabled && hasPermissions([PERMISSIONS.users.permissions.canEnableUsers.value])"
                type="primary"
                class="govuk-!-margin-right-2"
                :action="() => toggleDisableUser(user.uid, userIndex)"
              >
                Enable user
              </ActionButton>
              <ActionButton
                v-if="!user.disabled && hasPermissions([PERMISSIONS.users.permissions.canEnableUsers.value])"
                type="secondary"
                class="govuk-!-margin-right-2"
                :action="() => toggleDisableUser(user.uid, userIndex)"
              >
                Disable user
              </ActionButton>
              <button
                v-if="hasPermissions([PERMISSIONS.users.permissions.canDeleteUsers.value])"
                class="govuk-button govuk-button--warning"
                @click="confirmDeleteUser(userIndex)"
              >
                Delete user
              </button>
            </td>
          </tr>
        </table>
      </div>

      <div
        v-show="activeTab === 'roles'"
        class="print-full-width"
      >
        <div class="govuk-grid-row">
          <div class="govuk-grid-column-one-quarter print-none">
            <!-- TODO: consider refactoring this -->
            <nav
              class="moj-side-navigation govuk-!-padding-top-0"
              :aria-label="'side-navigation'"
            >
              <ul class="moj-side-navigation__list">
                <h4

                  class="moj-side-navigation__title"
                >
                  Roles
                </h4>
                <ul
                  v-if="roles.length > 0"
                  class="moj-side-navigation__list"
                >
                  <!-- TODO: Sort the active class -->
                  <li
                    v-for="(roleItem, roleIndex) in roles"
                    :key="roleIndex"
                    :class=" isActive(roleItem.id) ? 'moj-side-navigation__item moj-side-navigation__item--active' : 'moj-side-navigation__item'"
                  >
                    <a
                      href="#"
                      class="moj-side-navigation__item"
                      @click.prevent="viewRolePermissions(roleIndex)"
                    >
                      {{ roleItem.roleName }} {{ roleItem.isDefault ? '(Default)' : '' }}
                    </a>
                  </li>
                </ul>
                <span v-else>No roles</span>
              </ul>
            </nav>
          </div>
          <div class="govuk-grid-column-three-quarters print-full-width">
            <div class="govuk-grid-row print-none">
              <div class="govuk-grid-column-one-half">
                <h1>Roles</h1>
              </div>
              <div
                v-if="hasPermissions([PERMISSIONS.users.permissions.canCreateRoles.value])"
                class="govuk-grid-column-one-half"
              >
                <div class="text-right">
                  <button
                    class="govuk-button govuk-!-margin-right-1 govuk-!-margin-top-3 govuk-!-margin-bottom-3"
                    @click="openCreateRoleModal()"
                  >
                    Create a new role
                  </button>
                </div>
              </div>
            </div>
            <div
              v-if="role"
              ref="role"
            >
              <h1>{{ role.roleName }}</h1>

              <div
                v-for="(value, key) in PERMISSIONS"
                :key="key"
              >
                <h2>{{ value.label }}</h2>
                <Checkbox
                  v-for="(subValue, subKey) in value.permissions"
                  :id="subKey"
                  :key="subKey"
                  v-model="permissions[subKey]"
                >
                  {{ subValue.label }}
                </Checkbox>
              </div>

              <div v-if="hasPermissions([PERMISSIONS.users.permissions.canEditRolePermissions.value])">
                <ActionButton
                  type="primary"
                  class="govuk-!-margin-right-1"
                  :action="saveRole"
                >
                  Save role
                </ActionButton>
                <ActionButton
                  type="secondary"
                  :disabled="role.isDefault"
                  :action="setDefaultRole"
                >
                  Set as default role
                </ActionButton>
              </div>
            </div>
            <div v-else>
              <h3>Select a role on the left to edit.</h3>
            </div>
          </div>
        </div>
      </div>
    </div>
    <Modal
      ref="modalRef"
    >
      <div class="modal__title govuk-!-padding-2 govuk-heading-m">
        Create a new role
      </div>
      <div
        v-if="!roleId"
        class="modal__content govuk-!-margin-6"
      >
        <TextField
          :id="`user_role_id`"
          v-model="newRoleName"
          label="User role name"
          type="text"
        />
        <ActionButton
          class="govuk-!-margin-right-1"
          type="primary"
          :action="createUserRole"
        >
          Save and set permissions
        </ActionButton>
        <button
          class="govuk-button govuk-button--secondary govuk-!-margin-right-3"
          @click="closeModal('modalRef')"
        >
          Cancel
        </button>
      </div>
    </Modal>
    <Modal
      ref="changingRole"
    >
      <div class="modal__content govuk-!-margin-6">
        <h2>
          Please wait...
        </h2>
      </div>
    </Modal>
    <Modal ref="modalRefDeleteUser">
      <div class="modal__title govuk-!-padding-2 govuk-heading-m">
        Are you sure to delete user?
      </div>
      <div class="modal__content govuk-!-margin-6">
        <ActionButton
          type="primary"
          class="govuk-!-margin-right-2"
          :action="deleteUser"
        >
          Delete
        </ActionButton>
        <button
          class="govuk-button govuk-button--secondary"
          @click="closeModal('modalRefDeleteUser')"
        >
          Cancel
        </button>
      </div>
    </Modal>

    <Modal ref="modalRefCreateUser">
      <div class="modal__title govuk-!-padding-2 govuk-heading-m">
        Create a new user
      </div>
      <div class="modal__content govuk-!-margin-6">
        <div
          class="govuk-grid-column-full"
          style="text-align: left;"
        >
          <TextField
            id="email"
            v-model="newUserEmail"
            label="Email"
            hint="The email must be a JAC email address."
            type="email"
            autocomplete="off"
            required
          />
          <p
            v-if="isDuplicateEmail"
            class="govuk-error-message"
          >
            Duplicate Email
          </p>
          <p
            v-if="isNotJACEmail"
            class="govuk-error-message"
          >
            Please use a JAC email address
          </p>

          <TextField
            id="password"
            v-model="newUserPassword"
            label="Password"
            hint="The password must be a string with at least 6 characters."
            type="password"
            autocomplete="off"
            required
          />

          <div class="govuk-form-group">
            <label class="govuk-heading-m govuk-!-margin-bottom-2">Role</label>
            <select
              id="role"
              v-model="newUserRole"
              class="govuk-select"
              style="width: 100%;"
            >
              <option
                v-for="(roleItem, roleIndex) in roles"
                :key="roleIndex"
                :value="roleItem.id"
              >
                {{ roleItem.roleName }}
              </option>
            </select>
          </div>
        </div>

        <ActionButton
          type="primary"
          class="govuk-!-margin-right-3"
          :disabled="!newUserEmail || isDuplicateEmail || isNotJACEmail || !isValidPassword "
          :action="createUser"
        >
          Save
        </ActionButton>
        <button
          class="govuk-button govuk-button--secondary govuk-!-margin-right-3"
          @click="closeCreateUserModal"
        >
          Cancel
        </button>
      </div>
    </Modal>
  </div>
</template>

<script>
import LoadingMessage from '@jac-uk/jac-kit/draftComponents/LoadingMessage.vue';
import { functions } from '@/firebase';
import ActionButton from '@jac-uk/jac-kit/draftComponents/ActionButton.vue';
import Warning from '@jac-uk/jac-kit/draftComponents/Warning.vue';
import TabsList from '@jac-uk/jac-kit/draftComponents/TabsList.vue';
import Modal from '@jac-uk/jac-kit/components/Modal/Modal.vue';
import Checkbox from '@jac-uk/jac-kit/draftComponents/Form/Checkbox.vue';
import TextField from '@jac-uk/jac-kit/draftComponents/Form/TextField.vue';
import permissionMixin from '@/permissionMixin';

export default {
  components: {
    LoadingMessage,
    ActionButton,
    Warning,
    TabsList,
    Modal,
    Checkbox,
    TextField,
  },
  mixins: [permissionMixin],
  data() {
    return {
      loaded: false,
      loadFailed: false,
      users: [],
      roles: [],
      activeTab: 'users',
      roleId: null,
      role: null,
      rolePermissions: null,
      newRoleName: null,
      permissions: {},
      selectedUserIndex: null,
      newUserEmail: '',
      newUserPassword: '',
      newUserRole: '',
    };
  },
  computed: {
    tabs() {
      return [
        {
          ref: 'users',
          title: 'Users',
        },
        {
          ref: 'roles',
          title: 'Roles',
        },
      ];
    },
    isDuplicateEmail() {
      return this.users.map(user => user.email).includes(this.newUserEmail);
    },
    isNotJACEmail() {
      return this.newUserEmail && !this.newUserEmail.match(/@judicialappointments.(digital|gov.uk)$/);
    },
    isValidPassword() {
      return this.newUserPassword.length >= 6;
    },
    defaultUserRole() {
      const role = this.roles.find(r => r.isDefault);
      return role ? role.id : '';
    },
    rolesNav() {
      const rolesNav = [];
      for (const role of this.roles) {
        rolesNav.push({
          title: role.roleName,
          name: role.id,
        });
      }
      return rolesNav;
    },
  },
  async mounted() {
    await this.getUsers();
    await this.getRoles();
  },
  updated() {
    const canEditRolePermissions = this.hasPermissions([this.PERMISSIONS.users.permissions.canEditRolePermissions.value]);
    if (!canEditRolePermissions) {
      const roleRef = this.$refs.role;
      if (roleRef) {
        const inputs = roleRef.querySelectorAll('input');
        inputs && inputs.forEach(input => input.disabled = true);
      }
    }
  },
  methods: {
    async getUsers() {
      try {
        const users = await functions.httpsCallable('adminGetUsers')();
        this.users = users.data;
        for (const user of this.users) {
          //TODO: add default role logic
          if (!user.customClaims) {
            user.customClaims = {
              r: 'not set',
            };
          }
        }
        this.loaded = true;
      } catch (e) {
        this.loadFailed = true;
        throw e;
      }
    },
    async getRoles() {
      const roles = await functions.httpsCallable('adminGetUserRoles')();
      this.roles = roles.data;
    },
    async toggleDisableUser(uid, index) {
      try {
        const response = await functions.httpsCallable('adminDisableUser')({ uid: uid });
        this.users[index].disabled = response.data.disabled;
        return true;
      } catch (error) {
        return;
      }
    },
    confirmDeleteUser(index) {
      this.selectedUserIndex = index;
      this.openModal('modalRefDeleteUser');
    },
    async deleteUser() {
      if (this.selectedUserIndex !== null) {
        const selectedUid = this.users[this.selectedUserIndex].uid;
        try {
          const response = await functions.httpsCallable('deleteUsers')({ uids: [selectedUid] });
          if (response && response.data.successCount) {
            this.users.splice(this.selectedUserIndex, 1);
            setTimeout(() => {
              this.closeModal('modalRefDeleteUser');
            }, 1000);
            return true;
          }
        } catch (error) {
          return false;
        }
      }
      return false;
    },
    openModal(modalRef){
      this.$refs[modalRef].openModal();
    },
    closeModal(modalRef) {
      this.rolePermissions = null;
      this.$refs[modalRef].closeModal();
      this.newRoleName = null;
      this.selectedUserIndex = null;
    },
    openCreateUserModal() {
      this.openModal('modalRefCreateUser');
      this.newUserRole = this.defaultUserRole;
    },
    closeCreateUserModal() {
      this.closeModal('modalRefCreateUser');
      this.resetNewUser();
    },
    resetNewUser() {
      this.newUserEmail = '';
      this.newUserPassword = '';
      this.newUserRole = '';
    },
    async createUser() {
      try {
        const res = await functions.httpsCallable('createUser')({
          email: this.newUserEmail,
          password: this.newUserPassword, // need to pass password to create new user
        });
        if (res && res.data && 'uid' in res.data) {
          await this.setUserRole(res.data.uid, this.newUserRole);
          await this.getUsers();
          this.resetNewUser();
          setTimeout(() => {
            this.closeCreateUserModal();
          }, 1000);
          return true;
        }
      } catch (error) {
        return;
      }
    },
    async handleRoleChange(user) {
      this.openModal('changingRole');
      await this.setUserRole(user.uid, user.customClaims.r);
      this.closeModal('changingRole');
    },
    async setUserRole(userId, roleId) {
      await functions.httpsCallable('adminSetUserRole')({ userId, roleId });
    },
    viewRolePermissions(roleIndex) {
      this.role = this.roles[roleIndex];
      // set all permissions to false
      const obj = {};
      for (const group of Object.keys(this.PERMISSIONS)) {
        for (const p of Object.keys(this.PERMISSIONS[group].permissions)) {
          obj[p] = false;
        }
      }
      // make it reactive
      this.permissions = Object.assign({}, obj);

      // set the enabled permissions for the role to true
      if (this.role.enabledPermissions) {
        for (const permission of this.role.enabledPermissions) {
          if (permission in this.permissions) {
            this.permissions[permission] = true;
          }
        }
      }

    },
    async createUserRole() {
      try {
        //TODO: enforce unique role name
        const response = await functions.httpsCallable('adminCreateUserRole')({ roleName: this.newRoleName });
        await this.getRoles();
        //this.role = Array.filter((role) => { return role.id === response.data.id; });
        this.role = this.roles.filter((role) => { return role.id === response.data.id; })[0];
        setTimeout(() => {
          this.closeModal('modalRef');
        }, 1000);
        return true;
      } catch (error) {
        return;
      }
    },
    async saveRole() {
      this.role.enabledPermissions = [];
      for (const permission in this.permissions) {
        if (this.permissions[permission]) {
          this.role.enabledPermissions.push(permission);
        }
      }
      try {
        return await functions.httpsCallable('adminUpdateUserRole')({ roleId: this.role.id, enabledPermissions: this.role.enabledPermissions });
      } catch (error) {
        return;
      }
    },
    async setDefaultRole() {
      try {
        await functions.httpsCallable('adminSetDefaultRole')({ roleId: this.role.id });
        await this.getRoles();
        this.role.isDefault = true;
        return true;
      } catch (error) {
        return;
      }
    },
    openCreateRoleModal() {
      this.openModal('modalRef');
    },
    isActive(roleId) {
      if (this.role) {
        return roleId === this.role.id;
      } else {
        return false;
      }
    },
  },

};
</script>

<style>
td .govuk-warning-text {
  margin-bottom: 0 !important;
}
</style>
